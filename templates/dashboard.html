<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UIDAI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- CLASSIC THEME VARIABLES --- */
        :root {
            --navy-dark: #263542;    
            --navy-light: #2c3e50;   
            --classic-bg: #f4f6f8;   
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --accent-blue: #2980b9;  
            --accent-gold: #f39c12;  
            --border-color: #dce1e4;
        }

        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--classic-bg); display: flex; height: 100vh; overflow: hidden; color: var(--text-dark); }

        /* --- SIDEBAR --- */
        .sidebar { width: 260px; background: var(--navy-dark); color: white; display: flex; flex-direction: column; padding: 25px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .sidebar h2 { font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 40px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; color: #ecf0f1; }
        .menu-item { padding: 14px 20px; color: #bdc3c7; text-decoration: none; display: block; margin-bottom: 8px; border-radius: 4px; font-size: 0.95rem; transition: all 0.3s ease; }
        .menu-item:hover, .active { background: var(--navy-light); color: white; border-left: 4px solid var(--accent-blue); }
        .logout { margin-top: auto; background: rgba(231, 76, 60, 0.1); color: #e74c3c !important; border: 1px solid #e74c3c; text-align: center; }
        .logout:hover { background: #e74c3c; color: white !important; }

        /* --- MAIN CONTENT --- */
        .main { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* HEADER AREA */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 20px 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); border: 1px solid var(--border-color); }
        .header-title h1 { margin: 0; font-size: 1.5rem; color: var(--navy-dark); }
        .header-title p { margin: 5px 0 0; color: var(--text-light); font-size: 0.9rem; }
        
        /* SELECTION TAB */
        .filter-group { text-align: right; }
        .filter-label { display: block; font-size: 0.8rem; font-weight: bold; color: var(--text-light); margin-bottom: 5px; text-transform: uppercase; }
        select { padding: 10px 15px; border-radius: 4px; border: 1px solid #bdc3c7; font-size: 1rem; color: var(--navy-dark); background: #fff; cursor: pointer; min-width: 250px; outline: none; }
        select:hover { border-color: var(--accent-blue); }

        /* --- KPI CARDS --- */
        .kpi-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(35, 50, 59, 0.02); transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(34, 33, 33, 0.05); }
        
        .kpi-label { font-size: 0.85rem; font-weight: 600; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-number { font-size: 2.2rem; font-weight: 700; color: var(--navy-dark); margin-top: 10px; }
        .kpi-number.highlight { color: var(--accent-blue); }

        /* --- TABS --- */
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); }
        .tab { padding: 12px 25px; cursor: pointer; font-weight: 500; color: var(--text-light); border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab:hover { color: var(--navy-dark); }
        .tab.active-tab { color: var(--navy-dark); border-bottom: 3px solid var(--navy-dark); }

        /* --- CHARTS AREA --- */
        .content-section { display: none; animation: fadeIn 0.4s; }
        .content-section.show { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 25px; }
        .chart-card { background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); height: 350px; }
        .chart-header { font-size: 1rem; font-weight: 600; color: var(--navy-dark); margin-bottom: 15px; border-left: 4px solid var(--accent-blue); padding-left: 10px; }

        /* --- REPORT & FAQ --- */
        .text-card { background: white; padding: 40px; border-radius: 8px; border: 1px solid var(--border-color); line-height: 1.6; }
        .report-line { margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid var(--navy-light); }
        
        .faq-item { border-bottom: 1px solid #eee; padding: 15px 0; cursor: pointer; }
        .faq-q { font-weight: 600; color: var(--navy-dark); display: flex; justify-content: space-between; }
        .faq-a { display: none; margin-top: 10px; color: #666; font-size: 0.95rem; }
        .faq-item.open .faq-a { display: block; }

    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Migration Intel</h2>
        <a href="#" class="menu-item active">Dashboard Overview</a>
        <a href="/reports" class="menu-item">Export Reports</a>
        <a href="/settings" class="menu-item">System Settings</a>
        <a href="/logout" class="menu-item logout">Sign Out</a>
    </div>

    <div class="main">
        
        <div class="header-bar">
            <div class="header-title">
                <h1>Executive Dashboard</h1>
                <p>Real-time analysis of demographic shifts and infrastructure demand.</p>
            </div>
            <div class="filter-group">
                <label class="filter-label">Geography Selection</label>
                <select id="stateFilter" onchange="fetchData()">
                    <option value="All">All India</option>
                    {% for state in states %}
                    <option value="{{ state }}">{{ state }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="kpi-container">
            <div class="card">
                <div class="kpi-label">Total Migration Volume</div>
                <div class="kpi-number" id="kpi-total">-</div>
            </div>
            
            <div class="card" style="border-left: 5px solid var(--accent-gold);">
                <div class="kpi-label">Top Receiving Hub</div>
                <div class="kpi-number highlight" id="kpi-hub">-</div>
                <div style="font-size: 0.8rem; color: #999; margin-top: 5px;">*Highest Inflow District</div>
            </div>

            <div class="card">
                <div class="kpi-label">Data Confidence</div>
                <div class="kpi-number" style="color: #27ae60;">98.4%</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active-tab" onclick="switchTab('charts')">Data Visualization</div>
            <div class="tab" onclick="switchTab('summary')">Intelligence Report</div>
            <div class="tab" onclick="switchTab('faq')">FAQ & Help</div>
        </div>

        <div id="charts" class="content-section show">
            <div class="charts-row">
                <div class="chart-card">
                    <div class="chart-header">Migration Trend (Daily Volume)</div>
                    <canvas id="lineChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-header">Demographic Split</div>
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
            <div class="chart-card" style="height: 400px;">
                <div class="chart-header" id="barTitle">Top Receiving Hubs</div>
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <div id="summary" class="content-section">
            <div class="text-card">
                <h3 style="margin-top:0; color: var(--navy-dark);">Automated Intelligence Summary</h3>
                <div id="report-content">Loading...</div>
            </div>
        </div>

        <div id="faq" class="content-section">
            <div class="text-card">
                <h3 style="margin-top:0;">System Documentation</h3>
                <div class="faq-item" onclick="this.classList.toggle('open')">
                    <div class="faq-q">What defines a "Receiving Hub"? <span>▼</span></div>
                    <div class="faq-a">A district is flagged as a Receiving Hub when demographic update volume (specifically address changes for age 18+) exceeds the rolling 30-day average by more than 15%.</div>
                </div>
                <div class="faq-item" onclick="this.classList.toggle('open')">
                    <div class="faq-q">How do I export this data? <span>▼</span></div>
                    <div class="faq-a">Navigate to the "Export Reports" tab in the sidebar to download CSV or PDF summaries.</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- CHART CONFIGURATION ---
        Chart.defaults.font.family = "'Roboto', sans-serif";
        Chart.defaults.color = '#7f8c8d';
        
        let charts = {};

        function switchTab(tabId) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active-tab'));
            document.getElementById(tabId).classList.add('show');
            event.target.classList.add('active-tab');
        }

        async function fetchData() {
            const state = document.getElementById('stateFilter').value;
            const res = await fetch(`/api/migration_data?state=${state}`);
            const data = await res.json();

            if(data.error) return;

            // Update KPIs
            document.getElementById('kpi-total').innerText = data.kpi.total;
            document.getElementById('kpi-hub').innerText = data.kpi.top_hub;
            document.getElementById('barTitle').innerText = "Top Receiving Hubs in " + state;

            // Update Charts
            renderLineChart(data.line_chart.labels, data.line_chart.values);
            renderBarChart(data.bar_chart.labels, data.bar_chart.values);
            renderPieChart(data.pie_chart.labels, data.pie_chart.values);

            // Update Report
            document.getElementById('report-content').innerHTML = data.summary.map(t => `<div class="report-line">${t}</div>`).join('');
        }

        function renderLineChart(labels, values) {
            const ctx = document.getElementById('lineChart').getContext('2d');
            if (charts['line']) charts['line'].destroy();

            charts['line'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Updates',
                        data: values,
                        borderColor: '#2980b9', /* Navy Blue */
                        backgroundColor: 'rgba(41, 128, 185, 0.05)',
                        borderWidth: 2,
                        pointRadius: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#2980b9',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false } },
                        y: { grid: { color: '#f0f0f0' }, beginAtZero: true }
                    }
                }
            });
        }

        // --- UPDATED: Gradient "Same Color/Light Multicolor" Effect ---
        function renderBarChart(labels, values) {
            const ctx = document.getElementById('barChart').getContext('2d');
            if (charts['bar']) charts['bar'].destroy();

            // "Same Color (Blue Family) but Light Multicolors (Variations)"
            // Fades from Dark Navy (Rank 1) to Light Teal/Grey (Rank 10)
            const gradientColors = [
                '#1a252f', // Darkest Navy (Top 1)
                '#243b55', 
                '#2e4f7a',
                '#2980b9', // Standard Blue
                '#3498db',
                '#5dade2',
                '#1abc9c', // Teal Start
                '#48c9b0',
                '#76d7c4',
                '#a3e4d7'  // Lightest Teal (Rank 10)
            ];

            charts['bar'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Updates',
                        data: values,
                        backgroundColor: gradientColors, // Applies the gradient array
                        borderRadius: 4
                    }]
                },
                options: { 
                    indexAxis: 'y', 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } }, y: { grid: { display: false } } }
                }
            });
        }

        function renderPieChart(labels, values) {
            const ctx = document.getElementById('pieChart').getContext('2d');
            if (charts['pie']) charts['pie'].destroy();

            charts['pie'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#bdc3c7', '#2980b9'], /* Light Grey vs Navy */
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%' }
            });
        }

        // Initialize
        fetchData();
    </script>
</body>
</html>